<div class"app-header">
    <div class="header-title" k="បញ្ជាក់ការកម្មង់">Review Order</div>
    <div class="back" ng-click="myGoBack()">
        <span class="ion-ios-arrow-left"></span>
    </div>
</div>

<div class="sm-modal" id="choose_location_modal">
    <div class="shadow"></div>
    <div class="header-title" k="ជ្រើសរើសខេត្តក្រុង">Choose City / Province</div>
    <div class="back" onclick="closeSmallModal('choose_location_modal')">
        <span class="close ion-ios-close-empty"></span>
    </div>                        
    <ion-content class="sm-modal-body">
        <ul id="choose_location_ul_2">
            
        </ul>
    </ion-content>
</div>    

<div class="sm-modal" id="choose_day_time_modal">
    <div class="shadow"></div>
    <div class="header-title" k="ជ្រើសរើសថ្ងៃនិងម៉ោង">Choose Date and Time</div>
    <div class="back" onclick="closeSmallModal('choose_day_time_modal')">
        <span class="close ion-ios-close-empty"></span>
    </div>                        
    <ion-content class="sm-modal-body" style="padding:20px 10px">
        <div class="yo">
            <ul id="choose_day_ul" class="a">
                
            </ul>
            <ul id="choose_time_ul" class="b">
               
            </ul>
        </div>
        <button class="c" k="យល់ព្រម" onclick="setScheduleDate()">Okay</button>       
    </ion-content>
</div>    



<div id="payment_method_modal" class="modal">
    <div class="header-title" k="របៀបបង់បា្រក់">Payment Method</div>
    <div class="back" onclick="closeModal('payment_method_modal')">
        <span class="close ion-ios-close-empty"></span>
    </div>
    <div class="uu">
        <div class="a item item-complex" onclick="selectPaymentMethod('cash_on_delivery')">
            <a class="item-content">
                <div class="b" k="បង់ប្រាក់ពេលទទួលទំនិញ" id="cash_on_delivery">Cash on Delivery</div>
                <div class="c">
                    <span k="បង់ប្រាក់ពេលលោកអ្នកបានទទួលទំនិញរួចរាល់">Pay when you receive the product</span>
                </div>
            </a>
        </div>
        
        <div class="a item item-complex" onclick="selectPaymentMethod('transfer_money')">
            <a class="item-content">
                <div class="b" k="ផ្ញើរប្រាក់តាមទូរស័ព្ទ">Transfer money</div>
                <div class="c payment" id="transfer_money">
                    <span k="ផ្ញើរប្រាក់តាម">Transfer money via</span>
                    <img class="d" src="img/wing.jpg"/>
                    <img class="e" src="img/true_money.jpg">
                    <img class="f" src="img/emoney.jpg">
                </div>
            </a>
        </div>
        
    </div>
</div>





<div id="delivery_time_modal" class="modal">
    <div class="header-title" k="ម៉ោងដឹកជញ្ជូន">Delivery Time</div>
    <div class="back" onclick="closeModal('delivery_time_modal')">
        <span class="close ion-ios-close-empty"></span>
    </div>
    <div class="uu">
        <div class="a item item-complex" onclick="selectDeliveryType('express')">
            <a class="item-content">
                <div class="b" k="ដឹកជញ្ជូនរហ័ស">Express Delivery</div>
                <div class="c">
                    <span k="ទទួលទំនិញ" id="express_delivery_type">Recieve Product</span>
                    <span id="express_delivery_day">Today</span>, 
                    <span id="express_delivery_time">10:00 - 11:00</div>
            </a>
        </div>
        <div class="a item item-complex"onclick="openSmallModal('choose_day_time_modal')">
            <a class="item-content">
                <div class="b" id="schedule_delivery_type" k="ដឹកជញ្ជូនក្នុងពេលកំណត់">Schedule Delivery</div>
                <div class="c">
                <span k="កំនត់ថ្ងៃនិងម៉ោងទទួលទំនិញ">Set date and time to recieve product</span>
            </div>
            </a>
        </div>
    </div>
</div>


<div id="shipping_info_modal" class="modal">
    <div class="header-title" k="អាស័យដ្ឋានដឹកជញ្ជូន">Delivery Address</div>
    <div class="back" onclick="closeModal('shipping_info_modal')">
        <span class="close ion-ios-close-empty"></span>
    </div>
    <div class="lg">
        <div class="cc">
            <form id="shipping_info_form">
                <div class="d">
                    <div class="e"><span class="ion-ios-person-outline"></span></div>
                    <div class="f"><input id="name" k="ឈ្មោះ" placeholder="Name" type="text">
                        <span style="display:none" class="input-close ion-ios-close-outline"></span>
                    </div>
                </div>
                <div class="d">
                    <div class="e"><span class="ion-ios-telephone"></span></div>
                    <div class="f"><input id="phone_number" k="ទូរស័ព្ទ" placeholder="Phone Number" type="number" pattern="\d*">
                        <span style="display:none" class="input-close ion-ios-close-outline"></span>
                    </div>
                </div>
                <div class="d">
                    <div class="e"><span class="ion-ios-location-outline"></span></div>
                    <div class="f"><span id="location" class="f2" onclick="openSmallModal('choose_location_modal')">Phnom Penh</span></div>
                    <div class="f1"><span class="fa fa-angle-right"></span></div>                                                    
                </div>
                <div id="phnom_penh_tab">
                    <div class="my-tab">
                        <div class="a selected" id="tab-address" onclick="selectTab('tab-address')">
                            <span k="អាស័យដ្ឋាន">ADDRESS</span>
                        </div>
                        <div class="a" id="tab-gps" onclick="selectTab('tab-gps'); getLocation()">
                            <span>GPS</span>
                        </div>
                    </div>
                    <div class="my-tab-content">
                        <div class="a" id="tab-address">
                            <div class="d">                    
                                <div class="f">
                                    <input id="address" k="អាស័យដ្ឋាន (ឧ: ផ្ទះលេខ 41 ផ្លូវ 126)" placeholder="Address (ex: No. 41, St. 126)">
                                    <span style="display:none" class="input-close ion-ios-close-outline"></span>
                                </div>
                            </div>
                            <div class="d">   
                                <div class="f"><input id="near_by" k="នៅជិត (ឧ: នៅជិតផ្សារធំថ្មី)" placeholder="Nearby (ex: Near Phsar Thom Thmey)">
                                    <span style="display:none" class="input-close ion-ios-close-outline"></span>
                                </div>
                            </div>
                            
                        </div>
                        <div class="a hide" id="tab-gps">
                            <div class="getting-gps" k="កំពុងទាញយកទីតាំងបច្ចុប្បន្នរបស់អ្នក ...">Getting your Current Location ...</div>
                            <iframe id="gps-map-frame" style="width:100%;height:250px" frameborder="0">                                
                            </iframe>                                                    
                            <input id="coordinate" type="hidden">
                        </div>
                    </div>
                </div>
                
                <div id="province_tab" style="display:none">
                    <div class="d">
                        <span class="dd" k="យើងខ្ញុំនឹងផ្ញើរទំនិញទៅតាមឡានក្រុង រឺឡានឈ្នួលទៅកានើខេត្តរបស់លោកអ្នក">We will send product via bus or rent car to your province.</span>
                    </div>
                    <div class="d">                    
                        <div class="f">
                            <input id="bus_name" k="ឈ្មោះឡានក្រុង រឺ ឡានឈ្នួល (បើមាន)" placeholder="Name of Bus, Rent Car (Optional)">
                            <span style="display:none" class="input-close ion-ios-close-outline"></span>
                        </div>
                    </div>
                    <div class="d">                    
                        <div class="f">
                            <input id="bus_name" k="លេខទូរស័ព្ទឡានក្រុង រឺ ឡានឈ្នួល (បើមាន)" placeholder="Phone Number of Bus, Rent Car (Optional)">
                            <span style="display:none" class="input-close ion-ios-close-outline"></span>
                        </div>
                    </div>
                </div>
     
                <div class="g">
                    <button type="submit" onclick="postAddress()" k="ផ្ញើរមកកាន់អាស័យដ្ឋាននេះ">Deliver to this Address</button>               
                </div>
            </form>
            
        </div>            
    </div>  
</div>

<script>/*****************************************************************/</script>

<ion-view hide-nav-bar="true" class="header-view">
    <ion-content id="order">
        
        
        <div class="eq">
            <div class="a" k="អាស័យដ្ឋានដឹកជញ្ជូន">Delivery Address</div>
            <div id="shipping_addr" class="item item-complex">
                
            </div>
            <div class="b item item-complex" id="add_address" onclick="openModal('shipping_info_modal')">
                <a class="item-content">
                    <span class="c" k="បន្ថែមអាស័យដ្ឋាន">Add an address</span>
                </a>
            </div>
        </div>
        <div class="hr"></div>
        <div class="et">
            <div class="a item item-complex" onclick="openModal('delivery_time_modal')">
                <a class="item-content">
                    <div class="b" id="delivery_type" k="ដឹកជញ្ជូនរហ័ស">Express Delivery</div>
                    <div class="c">
                        <span k="ទទួលទំនិញ">Receive Product</span>
                        <span id="delivery_day">Today</span>
                        <span id="delivery_time">08:00 - 09:00</span>    
                    </div>
                    <div class="fa fa-angle-right"></div>
                </a>
            </div>
        </div>
        
        <div class="et">
            <div class="a item item-complex" onclick="openModal('payment_method_modal')">
                <a class="item-content">
                    <div class="b" k="របៀបបង់ប្រាក់">Payment Method</div>
                    <div class="c payment">
                        <span class="ion-cash"></span> 
                        <span id="payment_method" k="បង់ប្រាក់ពេលទំនិញដល់ដៃ">Cash on Delivery</span>
                    </div>
                    <div class="fa fa-angle-right"></div>
                </a>
            </div>
        </div>
        
        <div class="hr"></div>
        <div class="wrap">
            <ul class="cart" id="cart-review">
                
            <ul>
        </div>  
        <div class="hr"></div>
        <div class="tp">
            
            <input id="msg_seller" placeholder="Message to the seller (Optional)" k="សារសំរាប់អ្នកលក់ (មិនបំពេញក៏បាន)"
            <span class="input-close ion-ios-close-outline"></span>
             
            <div class="a">
                <span k="សរុបទំនិញ">Subtotal</span> (<span class="cart_count"></span> <span k="មុខ">item</span>)
                <span class="subtotal"></span>
            </div>
            <div class="b">
                 <span k="ថ្លៃដឹកជញ្ជូន">Delivery Fee</span>
                <span class="delivery_fee"></span>
            </div>
            <div class="c"></div>
            <div class="d">
                <span k="សរុប">Total</span>
                <span class="total"></span>
            </div>
        </div>
       
    </ion-content>
    <div class="cart-footer">
        
        <div class="e" id="summary" style="display:none">
            <div class"ff">
                <span class="ion-ios-close-empty" onclick="$('.cart-footer #summary').hide()"></span>
                <center k="តម្លៃ">Summary</center>
            </div>            
            <div class="g">
                <span k="សរុបទំនិញ">Subtotal</span> (<span class="cart_count"></span> <span k="មុខ">item</span>)
                <span class="subtotal"></span>
            </div>
            <div class="g">
                <span k="ថ្លៃដឹកជញ្ជូន">Delivery Fee</span>
                <span class="delivery_fee"></span>
            </div>
            <div class="g h">
                <span k="សរុប">Total</span>
                <span class="total"></span>
            </div>
                
        </div>
        <div class="a" onclick="$('.cart-footer #summary').toggle()">
            <div class="aa">
                <div class="b"><span k="តម្លៃសរុប">Total</span></div>
                <div class="c"><span class="ion-arrow-down-b"></span></div>
            </div>
            <div class="ab"><span class="total"></span></div>
        </div>
        <div class="d" k="បញ្ជាទិញ" onclick="window.location.href='#tab/review_order/'">PLACE ORDER</div>
    </div>
    
</ion-view>
<script>
    la();         
    switchTab();
    
    
    function switchTab(){
        if (localStorage.getItem('delivery_to') != 'Phnom Penh,ភ្នំពេញ'){
            $('#shipping_info_form #phnom_penh_tab').hide();
            $('#shipping_info_form #province_tab').show();            
        } else {
            $('#shipping_info_form #phnom_penh_tab').show();
            $('#shipping_info_form #province_tab').hide();            
        }
    }
    
    function selectTab(tab){
        $('.my-tab-content .a').hide();
        $('.my-tab-content #'+tab).show();
        $('.my-tab .a').removeClass('selected');
        $('.my-tab #'+tab).addClass('selected');
    }
    function getLocation(){
        var onSuccess = function(position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            var str = 'https://www.google.com/maps/embed/v1/place?key=AIzaSyDocD-TtjQMfFFWBrBVUnl9BzBrhmX-AdA&q='+lat+','+lng;
            $('#gps-map-frame').attr('src', str);
            $('#coordinate').val(lat+','+lng);
            
        };
        navigator.geolocation.getCurrentPosition(onSuccess);
    }
    
    $.post('http://www.nekoten.khmerqq.com/module/date_select.php',{lang:lang}, function(data){        
        a = JSON.parse(data);
        for (var i = 0; i < a.length; i++){
            var str = '<li value="'+a[i]['val']+'"';
            if (i == 0) str += ' class="selected" ';
            str += 'onclick="selectDayTime(\'day\', \''+a[i]['val']+'\')">';
            str += a[i]['txt'];
            str += '</li>';
            $('.yo #choose_day_ul').append(str);
        }
    });
    
    
    var chosen_date = 'Today';
    $.post('http://www.nekoten.khmerqq.com/module/time_select.php',{lang:lang, chosen_date:chosen_date}, function(data){
        a = JSON.parse(data);
        for (var i = 0; i < a.length; i++){
            var str = '<li value="'+a[i]+'"';
            if (i == 0) str += ' class="selected" ';
            str += 'onclick="selectDayTime(\'time\', \''+a[i]+'\')">';
            str += a[i];
            str += '</li>';
            $('.yo #choose_time_ul').append(str);
        }
        
    });
    
    
    
    $.post('http://www.nekoten.khmerqq.com/app/shipping_info.php',{user_id:localStorage.getItem('user_id')}, function(data){
        var a = JSON.parse(data)[0];
        if (a['result'] == 'success'){
            $('.eq #add_address').hide();
            var str = '<a class="item-content"><b>'+a['name']+'</b><br>';
            str += a['address']+'<br>';
            str += a['location']+'<br>';
            str += 'Near by: '+a['near_by']+'<br>';
            str += 'Tel: '+a['phone_number']+'</span>';
            str += '<span class="fa fa-angle-right"></span></a>';
            $('.eq #shipping_addr').html(str);
        }
       
    });
    
    function selectLocation(name_en, name_kh){
        closeSmallModal('choose_location_modal');
        updateDeliveryTo(name_en, name_kh);
    }
    
    $.post('http://www.nekoten.khmerqq.com/app/location.php',{}, function(data){
        var arr = JSON.parse(data);
        for (var i = 0; i < arr.length; i++){
            var a = arr[i];
            var str = '<li class="item item-complex" onclick="selectLocation(\''+a['name_en']+'\', \''+a['name_kh']+'\')">';
                str += '<a class="item-content">';
                str += '<span k="'+a['name_kh']+'">'+a['name_en']+'</span>';
                str += '<span class="price-li">$ '+a['price']+' </span>';
            str += '</a></li>';
            $('#choose_location_ul_2').append(str); 
        }
        load('delivery_to');
        la();
    });
    
    
    
   
    function selectDeliveryType(type){
        closeModal('delivery_time_modal');
        $('#order #delivery_type').text($('#delivery_time_modal #'+type+'_delivery_type').text());
        $('#order #delivery_time').text($('#delivery_time_modal #'+type+'_delivery_time').text());
        $('#order #delivery_day').text($('#delivery_time_modal #'+type+'_delivery_day').text());
    }
    
    function selectPaymentMethod(type){
        closeModal('payment_method_modal');
        $('#order #payment_method').html($('#payment_method_modal #'+type).html());
    }
            
    function selectDayTime(type, val){
       $('#choose_'+type+'_ul li').removeClass('selected');
       $('#choose_'+type+'_ul li[value="'+val+'"]').addClass('selected');
    }
   
    function setScheduleDate(){
        closeModal('delivery_time_modal');
        closeSmallModal('choose_day_time_modal');
        $('.et #delivery_day').text($('.yo #choose_day_ul [class="selected"]').text());
        $('.et #delivery_time').text($('.yo #choose_time_ul [class="selected"]').text());
    }
    
    function postAddress(){
        var user_id = localStorage.getItem('user_id');
        var name = $('#shipping_info_form #name').val();
        var phone_number = $('#shipping_info_form #phone_number').val();
        var location = $('#shipping_info_form #location').text();
        var address = $('#shipping_info_form #address').val();
        var near_by = $('#shipping_info_form #near_by').val();
        
        var addr_selected = $('.my-tab #tab-address').hasClass('selected');
       
        if (addr_selected) {
            var coordinate = '';
        } else {
            var coordinate = $('#shipping_info_form #coordinate').val();
        }
        
        $.post('http://www.nekoten.khmerqq.com/app/post_address.php', {user_id:user_id, name: name, phone_number:phone_number, location:location, 
            address:address, near_by:near_by, coordinate:coordinate},
            function(data){
                if (data == 'success'){
                    var str = '<a class="item-content"><b>'+name+'</b><br>';
                    str += address+'<br>'+location+'<br>'+near_by+'<br>';
                    str += '<span class="ion-ios-telephone-outline"> '+phone_number+'</span></a><div class="fa fa-angle-right"></div>';
                    $('.eq #shipping_addr').html(str);
                    $('#add_address').hide();
                    closeModal('shipping_info_modal');
                }
            });                
        }
    /*
    var name = '1';
    var house = '2';
    var street = '3';
    var sangkat = '4';
    var khan = '5';
    var phone_number = '6';
    
    
    var str = '<a class="item-content"><b>'+name+'</b><br>';
                str += house+' '+street+'<br>';
                str += sangkat+' '+khan+'<br>';
                str += location+'<br>';
                str += '<span class="ion-ios-telephone-outline"> '+phone_number+'</span></a>';
                $('.eq #shipping_addr').html(str);
                closeModal('shipping_info');
    */
    $('#shipping_info_form input').on('keyup click', function(){
        if ($(this).val() != '') {
            $(this).siblings('.input-close').show();
        }
    });
    $('#shipping_info_form input').on('blur', function(){
            $(this).siblings('.input-close').hide();
    });
    $('#shipping_info_form .input-close').on('click', function(){
        $(this).hide();
        $(this).siblings('input').val('');
    });

   
</script>

